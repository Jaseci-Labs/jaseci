<html lang="en">

<head>
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="582296225245-3kqi04d89ahlk1kr8j15j1uolci0hrtq.apps.googleusercontent.com" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://accounts.google.com/gsi/client"></script>
</head>

<body class="row align-items-center">


    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col-12">

                <div class="jumbotron text-center">
                    <h1 class="display-4">Welcome!</h1>
                    <h4 class="display-5"></h4>

                    <p class="lead">This is a simple example of Jaseci's social authentication with Google</p>
                    <hr class="my-4">
                    <p>To continue please click on Sign in button and after successful authentication system will show user profile data</p>
                    <h1>Google Identity Services Authorization Token model</h1>
                    <br>
                    <br>
                        {% if code %}
                        <script>

                            var gCode = "{{code}}";

                            function show(id){
                                var container = document.getElementById(id)
                                container.style.display = "block";
                            }
                            function hide(id){
                                var container = document.getElementById(id)
                                container.style.display = "none";
                            }

                            function processToken(){
                            var request = $.ajax({
                                url: "/auth/google/",
                                type: "POST",
                                data: {
                                    id_token: "",
                                    code: gCode,
                                    access_token: "",
                                },
                            });

                            request.done(function(msg) {
                                console.log("msg", msg);
                                show("response-details")
                                document.getElementById("response-details").textContent = JSON.stringify(msg, undefined, 2);
                                GetUserDetails(msg.token);
                            });

                            request.fail(function(jqXHR, textStatus) {
                                alert("Request failed: " + textStatus);
                            });
                        }



                            function GetUserDetails(data) {

                                console.log("calling manage with token", data)
                                var request = $.ajax({
                                    "headers": {
                                        "Authorization": "token " + data,
                                        "Content-Type": "application/json",
                                    },
                                    url: "/user/manage/",
                                    type: "GET",
                                });
                                request.done(function(msg) {
                                    show("gresp");
                                    document.getElementById("gresp").textContent = JSON.stringify(msg, undefined, 2);
                                });

                                request.fail(function(jqXHR, textStatus) {
                                    alert("Request failed: " + textStatus);
                                });
                            }
                        processToken();

                        </script>
                        <div class="row justify-content-md-center">
                            <div class="col-md-3">
                                <p class="h4">Welcome!</p>
                            </div>
                        </div>
                        {% else %}
                        <script>
                            var clientID = "{{client_id}}";
                            var redirectURI = "{{redirect_uri}}";

                            const client = google.accounts.oauth2.initCodeClient({
                                client_id: clientID,
                                scope: 'https://www.googleapis.com/auth/calendar.readonly',
                                ux_mode: 'redirect',
                                redirect_uri: redirectURI,
                                state: "offline"
                                });
                        </script>
                        <div class="row justify-content-md-center">
                            <div class="col-md-3">
                            <button class="btn btn-outline-dark" onclick="client.requestCode();"  style="text-transform:none">
                                <img width="20px" style="margin-bottom:3px; margin-right:5px" alt="Google sign-in"
                                src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/512px-Google_%22G%22_Logo.svg.png" />
                                Login with Google
                            </button>
                        </div>
                        {% endif %}
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="container">
        <div class="row justify-content-md-center">
            <div class="col-12">
                <div class="jumbotron">
                    <p class=" h6 display-5">User token details: </h4>
                    <pre id="response-details">
                    </pre>
                    <hr>
                    <p class=" h6 display-5">Your user profile data: </h4>
                    <pre id="gresp">
                    </pre>
                </div>
            </div>
        </div>
    </div>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>


</body>

</html>